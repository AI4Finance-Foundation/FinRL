"""
FinRL è‚¡ç¥¨äº¤æ˜“å¼ºåŒ–å­¦ä¹ ç¯å¢ƒ (NumPyä¼˜åŒ–ç‰ˆ)

è¿™æ˜¯FinRLæ¡†æ¶çš„æ ¸å¿ƒè‚¡ç¥¨äº¤æ˜“ç¯å¢ƒï¼ŒåŸºäºOpenAI Gymnasiumæ ‡å‡†å®ç°ã€‚
è¯¥ç¯å¢ƒæ¨¡æ‹ŸçœŸå®çš„è‚¡ç¥¨äº¤æ˜“å¸‚åœºï¼Œä¸ºæ·±åº¦å¼ºåŒ–å­¦ä¹ æ™ºèƒ½ä½“æä¾›äº¤äº’æ¥å£ã€‚

ç¯å¢ƒç‰¹ç‚¹ï¼š
1. é«˜æ€§èƒ½ï¼šä½¿ç”¨NumPyä¼˜åŒ–ï¼Œæ”¯æŒå‘é‡åŒ–è®¡ç®—
2. çœŸå®æ€§ï¼šæ¨¡æ‹Ÿäº¤æ˜“æˆæœ¬ã€å¸‚åœºæ³¢åŠ¨å’Œé£é™©æ§åˆ¶
3. çµæ´»æ€§ï¼šæ”¯æŒå¤šç§äº¤æ˜“ç­–ç•¥å’Œé£é™©ç®¡ç†æœºåˆ¶
4. æ ‡å‡†åŒ–ï¼šéµå¾ªGymnasiumæ¥å£ï¼Œå…¼å®¹æ‰€æœ‰DRLç®—æ³•

å¼ºåŒ–å­¦ä¹ è¦ç´ ï¼š
- çŠ¶æ€(State)ï¼šåŒ…å«è´¦æˆ·ä¿¡æ¯ã€è‚¡ç¥¨ä»·æ ¼ã€æŠ€æœ¯æŒ‡æ ‡å’Œå¸‚åœºé£é™©æŒ‡æ ‡
- åŠ¨ä½œ(Action)ï¼šæ¯åªè‚¡ç¥¨çš„ä¹°å–æ•°é‡ï¼ˆè¿ç»­åŠ¨ä½œç©ºé—´ï¼‰
- å¥–åŠ±(Reward)ï¼šåŸºäºæŠ•èµ„ç»„åˆä»·å€¼å˜åŒ–çš„å³æ—¶å›æŠ¥
- ç¯å¢ƒ(Environment)ï¼šæ¨¡æ‹Ÿçš„è‚¡ç¥¨äº¤æ˜“å¸‚åœº

é‡‘èæ¦‚å¿µï¼š
- Portfolioï¼šæŠ•èµ„ç»„åˆï¼ŒåŒ…å«ç°é‡‘å’Œå¤šåªè‚¡ç¥¨çš„ç»„åˆ
- Turbulenceï¼šå¸‚åœºæ³¢åŠ¨åº¦ï¼Œç”¨äºé£é™©æ§åˆ¶
- Transaction Costï¼šäº¤æ˜“æˆæœ¬ï¼ŒåŒ…æ‹¬ä¹°å…¥å’Œå–å‡ºè´¹ç”¨
- Asset Allocationï¼šèµ„äº§é…ç½®ï¼Œåœ¨ä¸åŒèµ„äº§é—´åˆ†é…èµ„é‡‘

ä½œè€…ï¼šAI4Finance Foundation
"""
from __future__ import annotations

import gymnasium as gym
import numpy as np
from numpy import random as rd


class StockTradingEnv(gym.Env):
    """
    è‚¡ç¥¨äº¤æ˜“å¼ºåŒ–å­¦ä¹ ç¯å¢ƒ
    
    è¿™ä¸ªç¯å¢ƒç±»å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„è‚¡ç¥¨äº¤æ˜“æ¨¡æ‹Ÿå™¨ï¼Œæ™ºèƒ½ä½“å¯ä»¥åœ¨å…¶ä¸­
    å­¦ä¹ å¦‚ä½•è¿›è¡Œå¤šè‚¡ç¥¨æŠ•èµ„ç»„åˆç®¡ç†ã€‚ç¯å¢ƒæ”¯æŒè¿ç»­åŠ¨ä½œç©ºé—´ï¼Œå…è®¸
    æ™ºèƒ½ä½“å¯¹æ¯åªè‚¡ç¥¨è¿›è¡Œç²¾ç¡®çš„ä¹°å–å†³ç­–ã€‚
    
    ç¯å¢ƒè®¾è®¡åŸç†ï¼š
    1. çŠ¶æ€ç©ºé—´ï¼šåŒ…å«æŠ•èµ„ç»„åˆçš„å®Œæ•´ä¿¡æ¯
       - è´¦æˆ·ç°é‡‘
       - å¸‚åœºé£é™©æŒ‡æ ‡ï¼ˆæ³¢åŠ¨åº¦ï¼‰
       - è‚¡ç¥¨ä»·æ ¼å’ŒæŒä»“
       - æŠ€æœ¯æŒ‡æ ‡
    
    2. åŠ¨ä½œç©ºé—´ï¼šæ¯åªè‚¡ç¥¨çš„äº¤æ˜“æ•°é‡
       - æ­£å€¼ï¼šä¹°å…¥è‚¡ç¥¨
       - è´Ÿå€¼ï¼šå–å‡ºè‚¡ç¥¨
       - é›¶å€¼ï¼šä¸äº¤æ˜“
    
    3. å¥–åŠ±è®¾è®¡ï¼šåŸºäºæŠ•èµ„ç»„åˆä»·å€¼å˜åŒ–
       - çŸ­æœŸå¥–åŠ±ï¼šæ¯æ­¥çš„èµ„äº§ä»·å€¼å˜åŒ–
       - é•¿æœŸå¥–åŠ±ï¼šç´¯è®¡æŠ˜æ‰£å¥–åŠ±
    
    4. é£é™©æ§åˆ¶ï¼šé›†æˆå¤šç§é£é™©ç®¡ç†æœºåˆ¶
       - å¸‚åœºæ³¢åŠ¨åº¦ç›‘æ§
       - å¼ºåˆ¶å¹³ä»“æœºåˆ¶
       - äº¤æ˜“å†·å´æœŸ
    
    Attributes:
        price_ary: è‚¡ç¥¨ä»·æ ¼æ•°ç»„ (æ—¶é—´, è‚¡ç¥¨æ•°, ä»·æ ¼ç‰¹å¾)
        tech_ary: æŠ€æœ¯æŒ‡æ ‡æ•°ç»„ (æ—¶é—´, è‚¡ç¥¨æ•°, æŒ‡æ ‡æ•°)
        turbulence_ary: å¸‚åœºæ³¢åŠ¨åº¦æ•°ç»„ (æ—¶é—´,)
        state_dim: çŠ¶æ€ç©ºé—´ç»´åº¦
        action_dim: åŠ¨ä½œç©ºé—´ç»´åº¦ï¼ˆç­‰äºè‚¡ç¥¨æ•°é‡ï¼‰
    """
    
    def __init__(
        self,
        config,                    # ç¯å¢ƒé…ç½®å­—å…¸
        initial_account=1e6,       # åˆå§‹è´¦æˆ·èµ„é‡‘
        gamma=0.99,                # æŠ˜æ‰£å› å­
        turbulence_thresh=99,      # å¸‚åœºæ³¢åŠ¨åº¦é˜ˆå€¼
        min_stock_rate=0.1,        # æœ€å°äº¤æ˜“æ¯”ä¾‹
        max_stock=1e2,             # å•æ¬¡æœ€å¤§äº¤æ˜“è‚¡æ•°
        initial_capital=1e6,       # åˆå§‹èµ„æœ¬ï¼ˆä¸initial_accountç›¸åŒï¼‰
        buy_cost_pct=1e-3,         # ä¹°å…¥äº¤æ˜“æˆæœ¬æ¯”ä¾‹ï¼ˆ0.1%ï¼‰
        sell_cost_pct=1e-3,        # å–å‡ºäº¤æ˜“æˆæœ¬æ¯”ä¾‹ï¼ˆ0.1%ï¼‰
        reward_scaling=2**-11,     # å¥–åŠ±ç¼©æ”¾å› å­
        initial_stocks=None,       # åˆå§‹è‚¡ç¥¨æŒä»“
    ):
        """
        åˆå§‹åŒ–è‚¡ç¥¨äº¤æ˜“ç¯å¢ƒ
        
        Args:
            config (dict): ç¯å¢ƒé…ç½®ï¼ŒåŒ…å«:
                - price_array: ä»·æ ¼æ•°æ®æ•°ç»„
                - tech_array: æŠ€æœ¯æŒ‡æ ‡æ•°ç»„
                - turbulence_array: å¸‚åœºæ³¢åŠ¨åº¦æ•°ç»„
                - if_train: æ˜¯å¦ä¸ºè®­ç»ƒæ¨¡å¼
            initial_account (float): åˆå§‹è´¦æˆ·èµ„é‡‘ï¼Œé»˜è®¤100ä¸‡
            gamma (float): æŠ˜æ‰£å› å­ï¼Œç”¨äºè®¡ç®—é•¿æœŸç´¯è®¡å¥–åŠ±
            turbulence_thresh (float): å¸‚åœºæ³¢åŠ¨åº¦é˜ˆå€¼ï¼Œè¶…è¿‡æ—¶å¼ºåˆ¶å¹³ä»“
            min_stock_rate (float): æœ€å°äº¤æ˜“æ¯”ä¾‹ï¼Œé¿å…è¿‡å°çš„äº¤æ˜“
            max_stock (float): å•æ¬¡æœ€å¤§äº¤æ˜“è‚¡æ•°é™åˆ¶
            initial_capital (float): åˆå§‹èµ„æœ¬æ€»é¢
            buy_cost_pct (float): ä¹°å…¥äº¤æ˜“è´¹ç”¨ç™¾åˆ†æ¯”
            sell_cost_pct (float): å–å‡ºäº¤æ˜“è´¹ç”¨ç™¾åˆ†æ¯”
            reward_scaling (float): å¥–åŠ±ç¼©æ”¾ç³»æ•°ï¼Œè°ƒèŠ‚å¥–åŠ±å¤§å°
            initial_stocks (np.array): åˆå§‹è‚¡ç¥¨æŒä»“æ•°é‡
        """
        print("ğŸ—ï¸ åˆå§‹åŒ–è‚¡ç¥¨äº¤æ˜“å¼ºåŒ–å­¦ä¹ ç¯å¢ƒ...")
        
        # ==================== æ•°æ®åŠ è½½å’Œé¢„å¤„ç† ====================
        # ä»é…ç½®ä¸­æå–æ ¸å¿ƒæ•°æ®
        price_ary = config["price_array"]           # è‚¡ç¥¨ä»·æ ¼æ—¶é—´åºåˆ—
        tech_ary = config["tech_array"]             # æŠ€æœ¯æŒ‡æ ‡æ—¶é—´åºåˆ—
        turbulence_ary = config["turbulence_array"] # å¸‚åœºæ³¢åŠ¨åº¦æ—¶é—´åºåˆ—
        if_train = config["if_train"]               # è®­ç»ƒ/æµ‹è¯•æ¨¡å¼æ ‡å¿—
        
        # æ•°æ®ç±»å‹è½¬æ¢å’Œæ ‡å‡†åŒ–
        self.price_ary = price_ary.astype(np.float32)
        self.tech_ary = tech_ary.astype(np.float32)
        self.turbulence_ary = turbulence_ary

        # ==================== æ•°æ®æ ‡å‡†åŒ–å’Œé¢„å¤„ç† ====================
        # æŠ€æœ¯æŒ‡æ ‡æ ‡å‡†åŒ–ï¼šç¼©æ”¾åˆ°åˆé€‚çš„æ•°å€¼èŒƒå›´
        # 2**-7 â‰ˆ 0.0078ï¼Œå°†æŠ€æœ¯æŒ‡æ ‡å€¼ç¼©æ”¾åˆ°è¾ƒå°èŒƒå›´
        self.tech_ary = self.tech_ary * 2**-7
        
        # å¸‚åœºæ³¢åŠ¨åº¦å¤„ç†
        # ç”Ÿæˆæ³¢åŠ¨åº¦å¸ƒå°”æ ‡å¿—ï¼šTrueè¡¨ç¤ºé«˜æ³¢åŠ¨ï¼ˆå±é™©ï¼‰ï¼ŒFalseè¡¨ç¤ºæ­£å¸¸
        self.turbulence_bool = (turbulence_ary > turbulence_thresh).astype(np.float32)
        
        # ä½¿ç”¨sigmoidå‡½æ•°å¹³æ»‘å¤„ç†æ³¢åŠ¨åº¦ï¼Œé¿å…æ•°å€¼è¿‡å¤§
        self.turbulence_ary = (
            self.sigmoid_sign(turbulence_ary, turbulence_thresh) * 2**-5
        ).astype(np.float32)

        # ==================== ç¯å¢ƒå‚æ•°è®¾ç½® ====================
        stock_dim = self.price_ary.shape[1]  # è‚¡ç¥¨æ•°é‡
        
        # å¼ºåŒ–å­¦ä¹ å‚æ•°
        self.gamma = gamma                    # æŠ˜æ‰£å› å­ï¼Œæ§åˆ¶å¯¹æœªæ¥å¥–åŠ±çš„é‡è§†ç¨‹åº¦
        
        # äº¤æ˜“é™åˆ¶å‚æ•°
        self.max_stock = max_stock            # å•æ¬¡æœ€å¤§äº¤æ˜“è‚¡æ•°
        self.min_stock_rate = min_stock_rate  # æœ€å°äº¤æ˜“æ¯”ä¾‹
        
        # äº¤æ˜“æˆæœ¬å‚æ•°ï¼ˆæ¨¡æ‹ŸçœŸå®äº¤æ˜“è´¹ç”¨ï¼‰
        self.buy_cost_pct = buy_cost_pct      # ä¹°å…¥æ‰‹ç»­è´¹
        self.sell_cost_pct = sell_cost_pct    # å–å‡ºæ‰‹ç»­è´¹
        
        # å¥–åŠ±å’Œèµ„é‡‘å‚æ•°
        self.reward_scaling = reward_scaling  # å¥–åŠ±ç¼©æ”¾å› å­
        self.initial_capital = initial_capital # åˆå§‹èµ„æœ¬
        
        # åˆå§‹è‚¡ç¥¨æŒä»“è®¾ç½®
        self.initial_stocks = (
            np.zeros(stock_dim, dtype=np.float32)  # é»˜è®¤ç©ºä»“å¼€å§‹
            if initial_stocks is None
            else initial_stocks
        )

        # ==================== ç¯å¢ƒçŠ¶æ€å˜é‡åˆå§‹åŒ– ====================
        # è¿™äº›å˜é‡å°†åœ¨reset()æ–¹æ³•ä¸­æ­£å¼åˆå§‹åŒ–
        self.day = None                    # å½“å‰äº¤æ˜“æ—¥
        self.amount = None                 # è´¦æˆ·ç°é‡‘
        self.stocks = None                 # è‚¡ç¥¨æŒä»“æ•°é‡
        self.total_asset = None            # æ€»èµ„äº§ä»·å€¼
        self.gamma_reward = None           # ç´¯è®¡æŠ˜æ‰£å¥–åŠ±
        self.initial_total_asset = None    # åˆå§‹æ€»èµ„äº§

        # ==================== å¼ºåŒ–å­¦ä¹ ç¯å¢ƒä¿¡æ¯ ====================
        self.env_name = "StockEnv"
        
        # çŠ¶æ€ç©ºé—´ç»´åº¦è®¡ç®—
        # çŠ¶æ€åŒ…å«ï¼šç°é‡‘(1) + æ³¢åŠ¨åº¦æŒ‡æ ‡(2) + ä»·æ ¼*è‚¡ç¥¨æ•°*3 + æŠ€æœ¯æŒ‡æ ‡ç»´åº¦
        # 3å€æ˜¯å› ä¸ºåŒ…å«ï¼šå½“å‰ä»·æ ¼ã€æŒä»“æ•°é‡ã€å†·å´æ—¶é—´
        self.state_dim = 1 + 2 + 3 * stock_dim + self.tech_ary.shape[1]
        
        # äº¤æ˜“å†·å´æœºåˆ¶ï¼šé˜²æ­¢è¿‡åº¦é¢‘ç¹äº¤æ˜“
        self.stocks_cd = None
        
        # åŠ¨ä½œç©ºé—´ç»´åº¦ï¼šæ¯åªè‚¡ç¥¨ä¸€ä¸ªåŠ¨ä½œ
        self.action_dim = stock_dim
        
        # ç¯å¢ƒå‚æ•°
        self.max_step = self.price_ary.shape[0] - 1  # æœ€å¤§æ­¥æ•°
        self.if_train = if_train                     # è®­ç»ƒæ¨¡å¼æ ‡å¿—
        self.if_discrete = False                     # è¿ç»­åŠ¨ä½œç©ºé—´
        self.target_return = 10.0                    # ç›®æ ‡æ”¶ç›Šç‡
        self.episode_return = 0.0                    # å›åˆæ”¶ç›Šç‡

        # ==================== Gymnasiumæ ‡å‡†æ¥å£å®šä¹‰ ====================
        # è§‚å¯Ÿç©ºé—´ï¼šçŠ¶æ€çš„æ•°å€¼èŒƒå›´
        self.observation_space = gym.spaces.Box(
            low=-3000, high=3000,              # çŠ¶æ€å€¼èŒƒå›´
            shape=(self.state_dim,),           # çŠ¶æ€ç»´åº¦
            dtype=np.float32                   # æ•°æ®ç±»å‹
        )
        
        # åŠ¨ä½œç©ºé—´ï¼šæ¯åªè‚¡ç¥¨çš„äº¤æ˜“æ•°é‡ï¼ˆæ ‡å‡†åŒ–åï¼‰
        self.action_space = gym.spaces.Box(
            low=-1, high=1,                    # åŠ¨ä½œå€¼èŒƒå›´[-1,1]
            shape=(self.action_dim,),          # åŠ¨ä½œç»´åº¦
            dtype=np.float32                   # æ•°æ®ç±»å‹
        )
        
        print(f"  ğŸ“Š ç¯å¢ƒå‚æ•°:")
        print(f"    - è‚¡ç¥¨æ•°é‡: {stock_dim}")
        print(f"    - äº¤æ˜“å¤©æ•°: {self.max_step + 1}")
        print(f"    - çŠ¶æ€ç»´åº¦: {self.state_dim}")
        print(f"    - åŠ¨ä½œç»´åº¦: {self.action_dim}")
        print(f"    - åˆå§‹èµ„é‡‘: ${initial_capital:,.0f}")
        print(f"    - äº¤æ˜“æˆæœ¬: ä¹°å…¥{buy_cost_pct*100:.1f}%, å–å‡º{sell_cost_pct*100:.1f}%")
        print("  âœ… è‚¡ç¥¨äº¤æ˜“ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ")

    def reset(
        self,
        *,
        seed=None,      # éšæœºç§å­
        options=None,   # é¢å¤–é€‰é¡¹
    ):
        """
        é‡ç½®ç¯å¢ƒåˆ°åˆå§‹çŠ¶æ€
        
        è¿™ä¸ªæ–¹æ³•åœ¨æ¯ä¸ªå›åˆå¼€å§‹æ—¶è°ƒç”¨ï¼Œå°†ç¯å¢ƒé‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚
        åœ¨è®­ç»ƒæ¨¡å¼ä¸‹ä¼šæ·»åŠ éšæœºæ€§ï¼Œåœ¨æµ‹è¯•æ¨¡å¼ä¸‹ä¿æŒç¡®å®šæ€§ã€‚
        
        Args:
            seed: éšæœºç§å­ï¼Œç”¨äºå¯é‡å¤å®éªŒ
            options: é¢å¤–çš„é‡ç½®é€‰é¡¹
        
        Returns:
            tuple: (åˆå§‹çŠ¶æ€, ä¿¡æ¯å­—å…¸)
        
        é‡ç½®ç­–ç•¥ï¼š
        - è®­ç»ƒæ¨¡å¼ï¼šæ·»åŠ éšæœºæ€§ï¼Œæé«˜æ¢ç´¢èƒ½åŠ›
        - æµ‹è¯•æ¨¡å¼ï¼šä½¿ç”¨å›ºå®šåˆå§‹å€¼ï¼Œç¡®ä¿ç»“æœå¯æ¯”è¾ƒ
        """
        print("ğŸ”„ é‡ç½®äº¤æ˜“ç¯å¢ƒ...")
        
        # é‡ç½®äº¤æ˜“æ—¥åˆ°ç¬¬0å¤©
        self.day = 0
        price = self.price_ary[self.day]  # è·å–ç¬¬ä¸€å¤©çš„è‚¡ç¥¨ä»·æ ¼

        if self.if_train:
            # ========== è®­ç»ƒæ¨¡å¼ï¼šæ·»åŠ éšæœºæ€§ ==========
            print("  ğŸ² è®­ç»ƒæ¨¡å¼ï¼šæ·»åŠ éšæœºåˆå§‹åŒ–")
            
            # éšæœºåˆå§‹åŒ–è‚¡ç¥¨æŒä»“ï¼ˆ0-64è‚¡éšæœºæ•°é‡ï¼‰
            # è¿™ç§éšæœºæ€§æœ‰åŠ©äºæ™ºèƒ½ä½“å­¦ä¹ ä¸åŒçš„åˆå§‹çŠ¶æ€
            self.stocks = (
                self.initial_stocks + rd.randint(0, 64, size=self.initial_stocks.shape)
            ).astype(np.float32)
            
            # åˆå§‹åŒ–è‚¡ç¥¨å†·å´æ—¶é—´ï¼ˆé˜²æ­¢è¿‡åº¦é¢‘ç¹äº¤æ˜“ï¼‰
            self.stocks_cool_down = np.zeros_like(self.stocks)
            
            # éšæœºè°ƒæ•´åˆå§‹ç°é‡‘ï¼ˆ95%-105%èŒƒå›´å†…æ³¢åŠ¨ï¼‰
            # å‡å»è‚¡ç¥¨ä»·å€¼ï¼Œç¡®ä¿æ€»èµ„äº§åœ¨åˆç†èŒƒå›´å†…
            self.amount = (
                self.initial_capital * rd.uniform(0.95, 1.05)
                - (self.stocks * price).sum()
            )
        else:
            # ========== æµ‹è¯•æ¨¡å¼ï¼šç¡®å®šæ€§åˆå§‹åŒ– ==========
            print("  ğŸ“Š æµ‹è¯•æ¨¡å¼ï¼šç¡®å®šæ€§åˆå§‹åŒ–")
            
            # ä½¿ç”¨å›ºå®šçš„åˆå§‹è‚¡ç¥¨æŒä»“
            self.stocks = self.initial_stocks.astype(np.float32)
            
            # åˆå§‹åŒ–è‚¡ç¥¨å†·å´æ—¶é—´
            self.stocks_cool_down = np.zeros_like(self.stocks)
            
            # ä½¿ç”¨å›ºå®šçš„åˆå§‹ç°é‡‘
            self.amount = self.initial_capital

        # ==================== è®¡ç®—åˆå§‹èµ„äº§çŠ¶æ€ ====================
        # è®¡ç®—æ€»èµ„äº§ï¼šç°é‡‘ + è‚¡ç¥¨å¸‚å€¼
        self.total_asset = self.amount + (self.stocks * price).sum()
        
        # è®°å½•åˆå§‹æ€»èµ„äº§ï¼Œç”¨äºè®¡ç®—æœ€ç»ˆæ”¶ç›Šç‡
        self.initial_total_asset = self.total_asset
        
        # åˆå§‹åŒ–ç´¯è®¡å¥–åŠ±
        self.gamma_reward = 0.0
        
        print(f"  ğŸ’° åˆå§‹çŠ¶æ€:")
        print(f"    - ç°é‡‘: ${self.amount:,.0f}")
        print(f"    - è‚¡ç¥¨å¸‚å€¼: ${(self.stocks * price).sum():,.0f}")
        print(f"    - æ€»èµ„äº§: ${self.total_asset:,.0f}")
        print("  âœ… ç¯å¢ƒé‡ç½®å®Œæˆ")
        
        # è¿”å›åˆå§‹çŠ¶æ€å’Œç©ºçš„ä¿¡æ¯å­—å…¸ï¼ˆGymnasiumæ ‡å‡†ï¼‰
        return self.get_state(price), {}

    def step(self, actions):
        """
        æ‰§è¡Œä¸€æ­¥äº¤æ˜“åŠ¨ä½œ
        
        è¿™æ˜¯å¼ºåŒ–å­¦ä¹ ç¯å¢ƒçš„æ ¸å¿ƒæ–¹æ³•ï¼Œæ¥æ”¶æ™ºèƒ½ä½“çš„åŠ¨ä½œï¼Œ
        æ›´æ–°ç¯å¢ƒçŠ¶æ€ï¼Œå¹¶è¿”å›æ–°çš„è§‚å¯Ÿã€å¥–åŠ±å’Œå®Œæˆæ ‡å¿—ã€‚
        
        Args:
            actions (np.array): æ ‡å‡†åŒ–çš„åŠ¨ä½œæ•°ç»„ï¼ŒèŒƒå›´[-1,1]
        
        Returns:
            tuple: (æ–°çŠ¶æ€, å¥–åŠ±, æ˜¯å¦ç»“æŸ, æ˜¯å¦æˆªæ–­, ä¿¡æ¯å­—å…¸)
        
        äº¤æ˜“é€»è¾‘ï¼š
        1. åŠ¨ä½œé¢„å¤„ç†ï¼šå°†æ ‡å‡†åŒ–åŠ¨ä½œè½¬æ¢ä¸ºå®é™…äº¤æ˜“æ•°é‡
        2. é£é™©æ£€æŸ¥ï¼šæ£€æŸ¥å¸‚åœºæ³¢åŠ¨åº¦ï¼Œå†³å®šæ˜¯å¦å…è®¸äº¤æ˜“
        3. æ‰§è¡Œäº¤æ˜“ï¼šæŒ‰ç…§åŠ¨ä½œæ‰§è¡Œä¹°å–æ“ä½œ
        4. æ›´æ–°çŠ¶æ€ï¼šè®¡ç®—æ–°çš„æŠ•èµ„ç»„åˆçŠ¶æ€
        5. è®¡ç®—å¥–åŠ±ï¼šåŸºäºèµ„äº§å˜åŒ–è®¡ç®—å¥–åŠ±
        """
        # ==================== åŠ¨ä½œé¢„å¤„ç† ====================
        # å°†æ ‡å‡†åŒ–åŠ¨ä½œ[-1,1]è½¬æ¢ä¸ºå®é™…äº¤æ˜“è‚¡æ•°
        # æ­£æ•°è¡¨ç¤ºä¹°å…¥ï¼Œè´Ÿæ•°è¡¨ç¤ºå–å‡º
        actions = (actions * self.max_stock).astype(int)

        # ==================== æ—¶é—´æ¨è¿› ====================
        self.day += 1
        price = self.price_ary[self.day]    # è·å–å½“å¤©è‚¡ç¥¨ä»·æ ¼
        self.stocks_cool_down += 1          # æ›´æ–°è‚¡ç¥¨å†·å´æ—¶é—´

        # ==================== é£é™©æ§åˆ¶æ£€æŸ¥ ====================
        if self.turbulence_bool[self.day] == 0:
            # ========== æ­£å¸¸å¸‚åœºæ¡ä»¶ï¼šæ‰§è¡Œäº¤æ˜“ ==========
            print(f"ğŸ“ˆ ç¬¬{self.day}å¤©ï¼šæ­£å¸¸äº¤æ˜“æ¨¡å¼")
            
            # è®¡ç®—æœ€å°äº¤æ˜“æ•°é‡é˜ˆå€¼
            min_action = int(self.max_stock * self.min_stock_rate)
            
            # ========== å–å‡ºæ“ä½œå¤„ç† ==========
            # å¤„ç†æ‰€æœ‰å–å‡ºåŠ¨ä½œï¼ˆactions < -min_actionï¼‰
            for index in np.where(actions < -min_action)[0]:
                if price[index] > 0:  # ç¡®ä¿ä»·æ ¼æœ‰æ•ˆ
                    # è®¡ç®—å®é™…å–å‡ºæ•°é‡ï¼šä¸èƒ½è¶…è¿‡å½“å‰æŒä»“
                    sell_num_shares = min(self.stocks[index], -actions[index])
                    
                    # æ›´æ–°æŒä»“å’Œç°é‡‘
                    self.stocks[index] -= sell_num_shares
                    
                    # å–å‡ºæ”¶å…¥ = è‚¡ä»· Ã— æ•°é‡ Ã— (1 - æ‰‹ç»­è´¹)
                    self.amount += (
                        price[index] * sell_num_shares * (1 - self.sell_cost_pct)
                    )
                    
                    # é‡ç½®è¯¥è‚¡ç¥¨çš„å†·å´æ—¶é—´
                    self.stocks_cool_down[index] = 0
            
            # ========== ä¹°å…¥æ“ä½œå¤„ç† ==========
            # å¤„ç†æ‰€æœ‰ä¹°å…¥åŠ¨ä½œï¼ˆactions > min_actionï¼‰
            for index in np.where(actions > min_action)[0]:
                if price[index] > 0:  # ç¡®ä¿ä»·æ ¼æœ‰æ•ˆ
                    # è®¡ç®—å®é™…ä¹°å…¥æ•°é‡ï¼šå—é™äºå¯ç”¨ç°é‡‘
                    available_shares = self.amount // price[index]  # å¯ä¹°å…¥è‚¡æ•°
                    buy_num_shares = min(available_shares, actions[index])
                    
                    # æ›´æ–°æŒä»“å’Œç°é‡‘
                    self.stocks[index] += buy_num_shares
                    
                    # ä¹°å…¥æ”¯å‡º = è‚¡ä»· Ã— æ•°é‡ Ã— (1 + æ‰‹ç»­è´¹)
                    self.amount -= (
                        price[index] * buy_num_shares * (1 + self.buy_cost_pct)
                    )
                    
                    # é‡ç½®è¯¥è‚¡ç¥¨çš„å†·å´æ—¶é—´
                    self.stocks_cool_down[index] = 0

        else:
            # ========== é«˜æ³¢åŠ¨å¸‚åœºï¼šå¼ºåˆ¶å¹³ä»“ ==========
            print(f"âš ï¸ ç¬¬{self.day}å¤©ï¼šå¸‚åœºé«˜æ³¢åŠ¨ï¼Œæ‰§è¡Œå¼ºåˆ¶å¹³ä»“")
            
            # å–å‡ºæ‰€æœ‰è‚¡ç¥¨ï¼Œè½¬æ¢ä¸ºç°é‡‘
            # è¿™æ˜¯é‡è¦çš„é£é™©æ§åˆ¶æœºåˆ¶ï¼Œåœ¨å¸‚åœºæåº¦ä¸ç¨³å®šæ—¶ä¿æŠ¤èµ„äº§
            sell_amount = (self.stocks * price).sum() * (1 - self.sell_cost_pct)
            self.amount += sell_amount
            
            # æ¸…ç©ºæ‰€æœ‰æŒä»“
            self.stocks[:] = 0
            self.stocks_cool_down[:] = 0
            
            print(f"  ğŸ’° å¼ºåˆ¶å¹³ä»“æ”¶å…¥: ${sell_amount:,.0f}")

        # ==================== çŠ¶æ€æ›´æ–° ====================
        # è·å–æ–°çš„ç¯å¢ƒçŠ¶æ€
        state = self.get_state(price)
        
        # è®¡ç®—å½“å‰æ€»èµ„äº§ä»·å€¼
        total_asset = self.amount + (self.stocks * price).sum()
        
        # ==================== å¥–åŠ±è®¡ç®— ====================
        # è®¡ç®—å³æ—¶å¥–åŠ±ï¼šåŸºäºèµ„äº§ä»·å€¼å˜åŒ–
        reward = (total_asset - self.total_asset) * self.reward_scaling
        
        # æ›´æ–°æ€»èµ„äº§è®°å½•
        self.total_asset = total_asset

        # ==================== ç´¯è®¡å¥–åŠ±è®¡ç®— ====================
        # ä½¿ç”¨æŠ˜æ‰£å› å­è®¡ç®—é•¿æœŸç´¯è®¡å¥–åŠ±
        self.gamma_reward = self.gamma_reward * self.gamma + reward
        
        # ==================== å›åˆç»“æŸæ£€æŸ¥ ====================
        done = self.day == self.max_step  # æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æœ€åä¸€å¤©
        
        if done:
            # å›åˆç»“æŸæ—¶ä½¿ç”¨ç´¯è®¡å¥–åŠ±ä½œä¸ºæœ€ç»ˆå¥–åŠ±
            reward = self.gamma_reward
            
            # è®¡ç®—æ•´ä¸ªå›åˆçš„æ”¶ç›Šç‡
            self.episode_return = total_asset / self.initial_total_asset
            
            print(f"ğŸ äº¤æ˜“å›åˆç»“æŸ")
            print(f"  ğŸ“Š æœ€ç»ˆæ”¶ç›Šç‡: {(self.episode_return - 1) * 100:.2f}%")
            print(f"  ğŸ’° æœ€ç»ˆèµ„äº§: ${total_asset:,.0f}")
        
        # è¿”å›æ–°çŠ¶æ€ã€å¥–åŠ±ã€å®Œæˆæ ‡å¿—ã€æˆªæ–­æ ‡å¿—ï¼ˆFalseï¼‰ã€ä¿¡æ¯å­—å…¸
        return state, reward, done, False, dict()

    def get_state(self, price):
        """
        æ„å»ºå½“å‰ç¯å¢ƒçŠ¶æ€
        
        å°†æ‰€æœ‰ç›¸å…³ä¿¡æ¯ç»„åˆæˆä¸€ä¸ªçŠ¶æ€å‘é‡ï¼Œä¾›æ™ºèƒ½ä½“å†³ç­–ä½¿ç”¨ã€‚
        çŠ¶æ€åŒ…å«äº†æ™ºèƒ½ä½“åšå‡ºäº¤æ˜“å†³ç­–æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚
        
        Args:
            price (np.array): å½“å‰è‚¡ç¥¨ä»·æ ¼æ•°ç»„
        
        Returns:
            np.array: æ ‡å‡†åŒ–çš„çŠ¶æ€å‘é‡
        
        çŠ¶æ€ç»„æˆï¼š
        1. è´¦æˆ·ç°é‡‘ï¼ˆæ ‡å‡†åŒ–ï¼‰
        2. å¸‚åœºæ³¢åŠ¨åº¦æŒ‡æ ‡
        3. æ³¢åŠ¨åº¦å¸ƒå°”æ ‡å¿—
        4. è‚¡ç¥¨ä»·æ ¼ï¼ˆæ ‡å‡†åŒ–ï¼‰
        5. è‚¡ç¥¨æŒä»“ï¼ˆæ ‡å‡†åŒ–ï¼‰
        6. è‚¡ç¥¨å†·å´æ—¶é—´
        7. æŠ€æœ¯æŒ‡æ ‡
        """
        # ç°é‡‘æ•°é‡æ ‡å‡†åŒ–ï¼šé™¤ä»¥2^12=4096è¿›è¡Œç¼©æ”¾
        amount = np.array(self.amount * (2**-12), dtype=np.float32)
        
        # ä»·æ ¼å’ŒæŒä»“æ ‡å‡†åŒ–æ¯”ä¾‹å› å­
        scale = np.array(2**-6, dtype=np.float32)  # 1/64
        
        # æ‹¼æ¥æ‰€æœ‰çŠ¶æ€ä¿¡æ¯
        state = np.hstack((
            amount,                           # æ ‡å‡†åŒ–ç°é‡‘
            self.turbulence_ary[self.day],   # å¸‚åœºæ³¢åŠ¨åº¦
            self.turbulence_bool[self.day],  # æ³¢åŠ¨åº¦å¸ƒå°”æ ‡å¿—
            price * scale,                   # æ ‡å‡†åŒ–è‚¡ç¥¨ä»·æ ¼
            self.stocks * scale,             # æ ‡å‡†åŒ–æŒä»“æ•°é‡
            self.stocks_cool_down,           # è‚¡ç¥¨å†·å´æ—¶é—´
            self.tech_ary[self.day],         # æŠ€æœ¯æŒ‡æ ‡
        ))
        
        return state.astype(np.float32)

    @staticmethod
    def sigmoid_sign(ary, thresh):
        """
        Sigmoidå‡½æ•°å˜æ¢
        
        å¯¹æ•°ç»„è¿›è¡Œsigmoidå˜æ¢ï¼Œç”¨äºå¹³æ»‘å¤„ç†æ³¢åŠ¨åº¦æ•°æ®ã€‚
        è¿™ç§å˜æ¢å¯ä»¥å°†å¯èƒ½å¾ˆå¤§çš„æ³¢åŠ¨åº¦å€¼å‹ç¼©åˆ°åˆç†èŒƒå›´å†…ã€‚
        
        Args:
            ary (np.array): è¾“å…¥æ•°ç»„
            thresh (float): é˜ˆå€¼å‚æ•°
        
        Returns:
            np.array: å˜æ¢åçš„æ•°ç»„
        
        æ•°å­¦åŸç†ï¼š
        ä½¿ç”¨ä¿®æ­£çš„sigmoidå‡½æ•°ï¼š1/(1+exp(-x*e)) - 0.5
        è¿™ç¡®ä¿äº†è¾“å‡ºå€¼åœ¨åˆç†èŒƒå›´å†…ï¼ŒåŒæ—¶ä¿æŒåŸå§‹æ•°æ®çš„ç›¸å¯¹å…³ç³»
        """
        def sigmoid(x):
            # ä¿®æ­£çš„sigmoidå‡½æ•°ï¼Œè¾“å‡ºèŒƒå›´çº¦ä¸º[-0.5, 0.5]
            return 1 / (1 + np.exp(-x * np.e)) - 0.5

        # å…ˆå½’ä¸€åŒ–å†åº”ç”¨sigmoidï¼Œæœ€åè¿˜åŸå°ºåº¦
        return sigmoid(ary / thresh) * thresh
